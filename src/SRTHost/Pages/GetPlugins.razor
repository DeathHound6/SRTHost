@page "/GetPlugins"
@using System.Net.Http.Json;
@using System.Text.Json;
@using SRTPluginBase;
@using SRTPluginBase.Implementations;
@inject NavigationManager NavigationManager;
@inject IHttpClientFactory httpClientFactory;
<PageTitle>Get Plugins</PageTitle>

<div class="w-full h-full">
    @if (pluginHost is null || MainJson is null || ManifestHost is null || ManifestPlugins is null)
    {
        <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
    }
    else
    {
        <MudPaper Class="w-full h-full flex-col gap-4 rounded-none">
            <PageHeader>
                <MudText Typo="Typo.h5">Get Plugins</MudText>
            </PageHeader>
            @foreach (((IMainPluginEntry mainPluginEntry, IManifestEntryJson? manifestPluginJson), int index) in ManifestPlugins!.Select((mainPluginEntry, index) => (mainPluginEntry.Value, index)))
            {
                <PluginBar>
                    <PluginHeader>
                        <PluginTitle>@mainPluginEntry.DisplayName</PluginTitle>
                        @mainPluginEntry.Name<br/>
                        (@mainPluginEntry.Platform.ToString()) @mainPluginEntry.Type.ToString()
                    </PluginHeader>
                    <MudButtonGroup Color="Color.Secondary" Variant="Variant.Filled">
                        @if (pluginHost.LoadedPlugins.ContainsKey(mainPluginEntry.Name))
                        {
                            <MudButton Href="@GetPluginName(@mainPluginEntry.Name, "Reload")">
                                Reload
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Href="@GetPluginName(@mainPluginEntry.Name, "Load")">
                                Load
                            </MudButton>
                        }
                    </MudButtonGroup>
                </PluginBar>
            }
        </MudPaper>
    }
</div>

@code {
    private string GetPluginName(string name, string page) => $"api/v1/Plugin/{name}/{page}";
    // private string GetItemCssClass(int index) => index % 2 == 0 ? "even" : "odd";

    private IMainJson? MainJson { get; set; }
    private IManifestEntryJson? ManifestHost { get; set; }
    private IDictionary<string, (IMainPluginEntry, IManifestEntryJson)>? ManifestPlugins { get; set; }
    protected override async Task OnInitializedAsync()
    {
        using (HttpClient httpClient = httpClientFactory.CreateClient())
        {
            httpClient.BaseAddress = new Uri(NavigationManager.BaseUri);

            //MainJson = await httpClient.GetFromJsonAsync<MainJson>("https://raw.githubusercontent.com/SpeedRunTool/SRTPlugins/main/main.json", System.Text.Json.JsonSerializerOptions.Default);
            MainJson = await httpClient.GetFromJsonAsync<MainJson>("/api/v1/Debug/GenerateMainJson", System.Text.Json.JsonSerializerOptions.Default);

            //ManifestHost = await httpClient.GetFromJsonAsync<ManifestHostJson>(MasterJson?.Host.ManifestURL, System.Text.Json.JsonSerializerOptions.Default);
            ManifestHost = await httpClient.GetFromJsonAsync<ManifestEntryJson>("/api/v1/Debug/GenerateManifestHost", System.Text.Json.JsonSerializerOptions.Default);

            //ManifestPlugins = MainJson?.Plugins.ToDictionary(kvp => kvp.Name, (kvp) => (kvp, httpClient.GetFromJsonAsync<ManifestPluginJson>(kvp.ManifestURL, System.Text.Json.JsonSerializerOptions.Default).GetAwaiter().GetResult()));
            ManifestPlugins = new Dictionary<string, (IMainPluginEntry, IManifestEntryJson)>();
            foreach (IMainPluginEntry mainPluginEntry in MainJson!.Plugins)
            {
                ManifestPlugins.Add(mainPluginEntry.Name, (mainPluginEntry, mainPluginEntry.Manifest ?? new()));
            }
        }

        await base.OnInitializedAsync();
    }
}